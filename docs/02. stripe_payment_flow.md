# Stripe Custom Payment Flow â€” Key Steps
1. Backend: `stripe.paymentIntents.create()` â†’ create PaymentIntent  
2. Frontend: Call backend to fetch `clientSecret`  
3. Frontend: Display Stripe `CardElement` for card input  
4. Frontend: `stripe.createPaymentMethod()` â†’ create payment method  
5. Frontend: `stripe.confirmCardPayment(clientSecret, { payment_method })` â†’ confirm payment  
6. Frontend: Handle success or error response  
7. Secure backend keys, never expose secret keys frontend  
8. Use Stripe test card `4242 4242 4242 4242` for testing  
9. Show loading state during payment processing  

# FRONTEND: (React.js) Custom Stripe Payment Flow (Manual Way)
01.Install stripe package 
```js
npm install @stripe/react-stripe-js @stripe/stripe-js
```

02.Create Custom Payment Form Wrapper | Payment.jsx
```js
import React from "react";
import { Elements } from "@stripe/react-stripe-js";
import { loadStripe } from "@stripe/stripe-js";
import CheckoutForm from "./CheckoutForm";

// Load Stripe with your publishable key
const stripePromise = loadStripe("your_publishable_key_here");

const Payment = () => {
  return (
    <div>
      <h1>Stripe Manual Payment Example</h1>
      <Elements stripe={stripePromise}>
        <CheckoutForm />
      </Elements>
    </div>
  );
};

export default Payment;
```

03. Manual Payment Flow with Loading | CheckoutForm.jsx
```js
import React, { useEffect, useState } from "react";
import { CardElement, useStripe, useElements } from "@stripe/react-stripe-js";
import axios from "axios";

const CheckoutForm = () => {
  const [clientSecret, setClientSecret] = useState("");
  const [loading, setLoading] = useState(false);
  const stripe = useStripe();
  const elements = useElements();

  // Fetch clientSecret when component mounts
  useEffect(() => {
    const fetchClientSecret = async () => {
      try {
        const res = await axios.post("http://localhost:5000/create-payment-intent", {
          amountInCents: 500,      // Payment amount in cents ($5.00)
          parcelId: "parcel_1234", // Example metadata
          customerId: "user_001",
        });

        console.log("Response from Intent", res.data);
        setClientSecret(res.data.clientSecret);
      } catch (err) {
        console.error("Error fetching clientSecret:", err.message);
      }
    };

    fetchClientSecret();
  }, []);

  // Handle form submission and payment process
  const handleSubmit = async (e) => {
    e.preventDefault();

    if (!stripe || !elements || !clientSecret) return;

    setLoading(true);

    const card = elements.getElement(CardElement);

    try {
      // Create payment method
      const { error: pmError, paymentMethod } = await stripe.createPaymentMethod({
        type: "card",
        card,
      });

      if (pmError) {
        alert("Error: " + pmError.message);
        setLoading(false);
        return;
      }

      // Confirm card payment
      const { error: confirmError, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
        payment_method: paymentMethod.id,
      });

      if (confirmError) {
        alert("Payment failed: " + confirmError.message);
      } else if (paymentIntent.status === "succeeded") {
        alert("ğŸ‰ Payment successful!");

        // Save payment info to backend
        await axios.post("http://localhost:5000/save-payment", {
          amount: 500,
          parcelId: "parcel_1234",
          customerId: "user_001",
          paymentIntentId: paymentIntent.id,
          status: paymentIntent.status,
        });

        console.log("Payment info saved to database.");
      }
    } catch (error) {
      console.error("Payment submission error:", error.message);
    }

    setLoading(false);
  };

  return (
    <form onSubmit={handleSubmit}>
      <CardElement />
      <button type="submit" disabled={!stripe || loading}>
        {loading ? "Processing..." : "Pay $5"}
      </button>
    </form>
  );
};

export default CheckoutForm;

```

04. Run the React Frontend Code
```js
npm run dev   (if using Vite)
npm start     (if using CRA)
```

05. Use this test card
```js
Card Number: 4242 4242 4242 4242
Expiry: Any future date
CVC: Any 3 digits
ZIP: Any 5 digits
```

# BACKEND: Create Payment Intent
```js
01.Install required packages
npm install express cors stripe dotenv

02. Environment Setup | In .env file
STRIPE_SECRET_KEY=your_secret_key_here

03. POST: Create Payment Intent 
const Stripe = require("stripe");
const stripe = Stripe(process.env.STRIPE_SECRET_KEY);

app.post("/create-payment-intent", async (req, res) => {
  const { amountInCents, parcelId, customerId } = req.body;

  if (!amountInCents) {
    return res.status(400).json({ error: "Amount is required" });
  }

  try {
    const paymentIntent = await stripe.paymentIntents.create({
      amount: amountInCents, // Correct key for Stripe is `amount` | 500 Cents is $5.00
      currency: "usd",
      payment_method_types: ["card"],
    });

    res.send({ clientSecret: paymentIntent.client_secret, });
  } catch (error) {
    console.error("Stripe error:", error.message);
    res.status(500).json({ error: error.message });
  }
});

04. Run the Server Code
nodemon index.js
```
 
# Real World Payment Flow 

1. Customer â¡ clicks "Pay $5"  
    â†“  
2. React Frontend â¡ calls backend to create a PaymentIntent using stripe.paymentIntents.create()  
    â†“  
3. Express Backend â¡ Stripe creates PaymentIntent and returns clientSecret  
    â†“  
4. React Frontend â¡ collects card details via Stripe's CardElement  
    â†“  
5. React Frontend â¡ creates a PaymentMethod with stripe.createPaymentMethod()  
    â†“  
6. React Frontend â¡ confirms payment with stripe.confirmCardPayment(clientSecret, payment_method)  
    â†“  
7. Stripe â¡ processes payment and returns success or failure  
    â†“  
8. Frontend â¡ displays â€œPayment Successfulâ€ or â€œPayment Failedâ€ message  
